var Calysto;(function(Calysto){var Mvc;(function(Mvc){var AjaxForm;(function(AjaxForm){function IsAjaxFormSubmitEnabled(){return _isEnabled&&!_isDisabled}function UseAjaxFormSubmit(enable=true){enable===!1?_isDisabled=!0:_isEnabled||(_isEnabled=!0,Calysto.Page.OnEndResponse(()=>fnInitFormsInterceptor()))}function SubmitForm(formSelector,delay=0){setTimeout(()=>{let form=$$calysto(formSelector).First();fnCreateAndSendRequest(form)},delay)}function fnInitFormsInterceptor(){$$calysto("form").Where(f=>!f.$$CalystoInterceptor).ForEach(frm=>{frm.$$CalystoInterceptor=!0;let f1=frm;f1.submitBase=f1.submit;f1.submit=function(){let _safethis14=this;setTimeout(()=>fnHandleSubmitRequest(_safethis14),1);return false}}).On("submit",sender=>{setTimeout(()=>fnHandleSubmitRequest(sender),1);return!1})}function fnHandleSubmitRequest(sender){var _a;if(!IsAjaxFormSubmitEnabled()||((_a=Calysto.DataAnnotations.FindValidationService(sender))===null||_a===void 0?void 0:_a.Validate().Render().Interactive(!0).HasErrors())){return!1};fnCreateAndSendRequest(sender);return!1}function fnCreateAndSendRequest(frm){var _a;if(!frm){throw new Error("Form is null.");}let receivedHandler1=frm.getAttribute(Calysto.Constants.CalystoDomAttributes.CalystoFormHandler),targetSel1=frm.getAttribute(Calysto.Constants.CalystoDomAttributes.CalystoFormTarget);if(!targetSel1&&!receivedHandler1){Calysto.Core.IsDebugDefined&&console.log("Form has no target and no received handler.");return}let selectorId=Calysto.Utility.Dom.EnsureElementId(targetSel1||frm),appendArr=[{Key:"__RootSelectorKey",Value:selectorId}],items1=Calysto.Forms.SerializeContainer(frm);for(let item1 of items1){((_a=item1.Element)===null||_a===void 0?void 0:_a.disabled)&&appendArr.push({Key:item1.Name,Value:item1.Value})};Calysto.Core.IsDebugDefined;let mode1=frm.getAttribute(Calysto.Constants.CalystoDomAttributes.CalystoFormMode),timeout1=parseInt(frm.getAttribute("calysto-timeout"))||9e4,spinner1=Calysto.Mvc.UseCalystoSpinner(frm,!1),actionUrl=frm.getAttribute(Calysto.Constants.CalystoDomAttributes.CalystoFormDestination);if(!actionUrl){throw new Error("Invalid action url.");}else actionUrl=Calysto.Utility.Encoding.CalystoBase64.DecodeBase64StringToString(actionUrl);Calysto.Page.OnBeginRequest.Invoke();return new Calysto.Net.WebClient(actionUrl).AddRequestHeader(Calysto.Constants.WsjsHeaderConstants.XCalystoAjaxFormKey,Calysto.Constants.WsjsHeaderConstants.XCalystoAjaxFormValue).SetTimeout(timeout1).UploadHtmlForm(frm,appendArr).OnError((wclient,ev)=>{Calysto.Core.IsDebugDefined&&Calysto.Dialog.CreateError(ev+"").Show()}).OnLoad(wclient=>{let txt=wclient.GetResponseText(),loc1=wclient.xhr.getResponseHeader("location");if(loc1){location.assign(loc1);return}if(spinner1.Remove(),wclient.xhr.status<200||wclient.xhr.status>=300){let title1=wclient.xhr.status+" "+(wclient.xhr.statusText||Calysto.Net.HttpStatusCode[wclient.xhr.status]||""),body1=txt||title1;Calysto.Dialog.CreateError(body1,title1).Show()}else if(wclient.xhr.getResponseHeader(Calysto.Constants.WsjsHeaderConstants.XCalystoResponseContainerKey)==Calysto.Constants.WsjsHeaderConstants.XCalystoResponseContainerValue){let state=fnCreateResponseState();Calysto.Net.WebService.AjaxResponseReceivedHandler(wclient,state)}else{if(receivedHandler1){let result=new Calysto.BoxValue;if(receivedHandler1.Contains("=>")){let fn1=Calysto.Utility.Expressions.CompileLambdaNoReturnCheck(receivedHandler1);fn1(txt)}else if(Calysto.DataBinder.TryGetValue(window,receivedHandler1,result)){result.GetValue()(txt)}else throw new Error("Received handler supported: "+receivedHandler1);}if(targetSel1){mode1=mode1||"ReplaceChildren";for(let sel1 of targetSel1.split(",")){sel1=sel1.Trim();let items=Calysto.DomQuery.FromHtml(txt).Query(`${sel1}, //${sel1}`).Distinct().ChildNodes().ToArray();$$calysto(targetSel1)[mode1]((items===null||items===void 0?void 0:items.Any())?items:txt)}}}Calysto.Page.OnEndResponse.Invoke()}).Start()}function fnCreateResponseState(){return{fnErrorCallback:a=>{Calysto.Core.IsDebugDefined&&Calysto.Dialog.CreateError(a).Show()},fnResponseContainerCallback:a=>{Calysto.Core.IsDebugDefined&&console.log("fnResponseContainerCallback",a)},fnReturnValueCallback:a=>{Calysto.Core.IsDebugDefined&&console.log("fnReturnValueCallback",a)},fnResponseEndCallback:()=>{Calysto.Core.IsDebugDefined&&console.log("fnResponseEndCallback")}}}let _isEnabled=!1,_isDisabled=!1;AjaxForm.IsAjaxFormSubmitEnabled=IsAjaxFormSubmitEnabled;AjaxForm.UseAjaxFormSubmit=UseAjaxFormSubmit,AjaxForm.SubmitForm=SubmitForm})(AjaxForm=Mvc.AjaxForm||(Mvc.AjaxForm={}))})(Mvc=Calysto.Mvc||(Calysto.Mvc={}))})(Calysto||(Calysto={}))